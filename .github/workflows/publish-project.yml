name: Deploy Projects
on:
  push:
    branches: [master]
    paths:
        - 'projects/**'
  workflow_dispatch:
    inputs:
      force_deploy_all:
        description: 'Force deploy all projects'
        required: false
        default: 'false'

env:
  S3_BUCKET: teamsantos-static-websites
  BUILD_DIR: dist

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.changed.outputs.projects }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history

      - id: changed
        run: |
          echo "Checking for changed projects..."
          echo "Before commit: ${{ github.event.before }}"
          echo "Current commit: ${{ github.sha }}"
          
          # Check if this is a manual dispatch with force deploy
          if [ "${{ github.event.inputs.force_deploy_all }}" == "true" ]; then
            echo "Force deploy all projects requested"
            CHANGED=$(find projects -maxdepth 1 -mindepth 1 -type d 2>/dev/null | cut -d/ -f2 | sort -u || echo "")
          elif [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            # First push or new branch - check all project folders
            echo "First push detected, checking all projects"
            CHANGED=$(find projects -maxdepth 1 -mindepth 1 -type d 2>/dev/null | cut -d/ -f2 | sort -u || echo "")
          else
            # Check if both commits exist
            if git cat-file -e "${{ github.event.before }}" 2>/dev/null && git cat-file -e "${{ github.sha }}" 2>/dev/null; then
              echo "Both commits found, doing normal diff"
              CHANGED=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" 2>/dev/null \
                | grep '^projects/' | cut -d/ -f2 | sort -u || echo "")
            else
              echo "One or both commits not found, trying fallback methods..."
              # Try HEAD~1 comparison
              if git cat-file -e "HEAD~1" 2>/dev/null; then
                echo "Using HEAD~1 comparison"
                CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null \
                  | grep '^projects/' | cut -d/ -f2 | sort -u || echo "")
              else
                # Last resort - deploy all projects
                echo "Cannot determine changes, deploying all projects"
                CHANGED=$(find projects -maxdepth 1 -mindepth 1 -type d 2>/dev/null | cut -d/ -f2 | sort -u || echo "")
              fi
            fi
          fi
          
          # If still no changes detected, force deploy all as fallback
          if [ -z "$CHANGED" ]; then
            echo "No changes detected, falling back to deploy all projects"
            CHANGED=$(find projects -maxdepth 1 -mindepth 1 -type d 2>/dev/null | cut -d/ -f2 | sort -u || echo "")
          fi
          
          # Convert to space-separated string for output
          CHANGED_STR=$(echo "$CHANGED" | tr '\n' ' ' | sed 's/[[:space:]]*$//')
          echo "Changed projects: $CHANGED_STR"
          echo "projects=$CHANGED_STR" >> $GITHUB_OUTPUT

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.projects != ''
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'master' && 'production' || 'staging' }}
    container:
      image: ghcr.io/${{ github.repository_owner }}/static-websites:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install infra dependencies
        working-directory: infra
        run: npm ci

      - name: Bootstrap CDK (if needed)
        working-directory: infra
        shell: bash
        run: |
          echo "Checking if CDK bootstrap is needed in us-east-1..."
          if ! aws cloudformation describe-stacks --stack-name CDKToolkit --region us-east-1 2>/dev/null; then
            echo "CDK not bootstrapped in us-east-1, running bootstrap..."
            npx cdk bootstrap aws://${{ secrets.AWS_ACCOUNT_ID }}/us-east-1 --require-approval never
          else
            echo "CDK already bootstrapped in us-east-1"
          fi

      - name: Deploy infrastructure
        working-directory: infra
        shell: bash
        run: |
            echo "Raw projects output: '${{ needs.detect-changes.outputs.projects }}'"
            IFS=' ' read -ra PROJ_ARR <<< "${{ needs.detect-changes.outputs.projects }}"
            for project in "${PROJ_ARR[@]}"; do
            if [ -n "$project" ]; then
              echo "Deploying infra for $project"
              # Fix: Make sure the context parameter is properly quoted and formatted
              npx cdk deploy --require-approval never -c "projects=$project"
              # Alternative: You might need to pass it differently depending on your CDK app
              # npx cdk deploy --require-approval never --context "projects=$project"
            fi
            done

      - name: Wait for CDK outputs
        working-directory: infra
        id: cdk-outputs
        shell: bash
        run: |
          IFS=' ' read -ra PROJ_ARR <<< "${{ needs.detect-changes.outputs.projects }}"
          for project in "${PROJ_ARR[@]}"; do
            if [ -n "$project" ]; then
              BUCKET=$(aws cloudformation describe-stacks \
                --stack-name Site-$project \
                --query "Stacks[0].Outputs[?ExportName=='${project}-bucket'].OutputValue" \
                --output text)
              echo "${project}_BUCKET=$BUCKET" >> $GITHUB_ENV
            fi
          done

      - name: Build projects
        shell: bash
        run: |
          IFS=' ' read -ra PROJ_ARR <<< "${{ needs.detect-changes.outputs.projects }}"
          for project in "${PROJ_ARR[@]}"; do
            if [ -n "$project" ]; then
              echo "Building project: $project"
              npm run build -- --root projects/$project --outDir dist/$project
            fi
          done

      - name: Sync built sites
        shell: bash
        run: |
          IFS=' ' read -ra PROJ_ARR <<< "${{ needs.detect-changes.outputs.projects }}"
          for project in "${PROJ_ARR[@]}"; do
            if [ -n "$project" ]; then
              # Fix the variable reference
              BUCKET_VAR="${project}_BUCKET"
              BUCKET_VALUE="${!BUCKET_VAR}"
              echo "Syncing $project to bucket: $BUCKET_VALUE"
              aws s3 sync $BUILD_DIR/$project s3://$BUCKET_VALUE/$project --delete
            fi
          done
